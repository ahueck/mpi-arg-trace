find_package(LLVM CONFIG HINTS "${LLVM_DIR}")
if(NOT LLVM_FOUND)
  message(STATUS "LLVM not found at: ${LLVM_DIR}.")
  find_package(LLVM REQUIRED CONFIG)
endif()

set_package_properties(LLVM PROPERTIES
  URL https://llvm.org/
  TYPE REQUIRED
  PURPOSE
  "LLVM framework installation required to test project."
)

message(STATUS "Found LLVM ${LLVM_PACKAGE_VERSION}")
list(APPEND CMAKE_MODULE_PATH "${LLVM_CMAKE_DIR}")
include(AddLLVM)


mpitracer_find_llvm_progs(MPITRACER_CLANG_EXEC "clang-${LLVM_VERSION_MAJOR};clang" DEFAULT_EXE "clang")
mpitracer_find_llvm_progs(MPITRACER_CLANGCXX_EXEC "clang++-${LLVM_VERSION_MAJOR};clang++" DEFAULT_EXE "clang++")

mpitracer_find_llvm_progs(MPITRACER_FILECHECK_EXEC
  "FileCheck-${LLVM_VERSION_MAJOR};FileCheck"
  ABORT_IF_MISSING
)

if(LLVM_EXTERNAL_LIT)
  cmake_path(GET LLVM_EXTERNAL_LIT PARENT_PATH LLVM_EXTERNAL_LIT_DIR)
endif()

mpitracer_find_llvm_progs(MPITRACER_LIT_EXEC
  "llvm-lit;lit;lit.py"
  HINTS ${LLVM_EXTERNAL_LIT_DIR} /usr/lib/llvm-${LLVM_VERSION_MAJOR} /usr/lib/llvm /usr/bin /usr/local/bin /opt/local/bin
  ABORT_IF_MISSING
)

macro(pythonize_bool truth_var var)
  if(${truth_var})
    set(${var} True)
  else()
    set(${var} False)
  endif()
endmacro()

function(configure_mpitracer_lit_site_cfg input output)
  set(LIT_SITE_CFG_IN_HEADER
      "## Autogenerated for mpitracer from ${input}\n## Do not edit!"
  )

  set(MPITRACER_PROJECT_DIR ${PROJECT_SOURCE_DIR})
  set(MPITRACER_LIBRARY_DIR ${CMAKE_BINARY_DIR}/lib)
  set(MPITRACER_SCRIPT_DIR ${MPITRACER_PROJECT_DIR}/scripts)

  mpitracer_target_generate_file(${input} ${output})
endfunction()

configure_mpitracer_lit_site_cfg(
  ${CMAKE_CURRENT_SOURCE_DIR}/lit.site.cfg.in
  ${CMAKE_CURRENT_BINARY_DIR}/lit.site.cfg
)

function(mpitracer_add_lit_testsuite target comment)
  cmake_parse_arguments(ARG "" "" "PARAMS;DEPENDS;ARGS" ${ARGN})

  foreach(param ${ARG_PARAMS})
    list(APPEND TEST_PARAMS --param ${param})
  endforeach()

  add_custom_target(${target}
    COMMAND ${MPITRACER_LIT_EXEC} ${ARG_ARGS} ${TEST_PARAMS} ${ARG_UNPARSED_ARGUMENTS}
    COMMENT "${comment}"
    USES_TERMINAL
  )

  if (ARG_DEPENDS)
    add_dependencies(${target} ${ARG_DEPENDS})
  endif()
endfunction()

function(mpitracer_add_lit_target)
  cmake_parse_arguments(ARG "" "" "SUITES" ${ARGN})

  foreach(suite IN LISTS ARG_SUITES)
    if("${suite}" STREQUAL "all")
      set(SUITE_PATH ${CMAKE_CURRENT_SOURCE_DIR})
      set(TARGET_NAME check-mpitracer)
    else()
      set(SUITE_PATH ${CMAKE_CURRENT_SOURCE_DIR}/${suite})
      set(TARGET_NAME check-mpitracer-${suite})
    endif()

    if(NOT EXISTS ${SUITE_PATH})
      message(WARNING "Could not find suitable lit test target at ${SUITE_PATH}")
      continue()
    endif()

    mpitracer_add_lit_testsuite(${TARGET_NAME}
      "Running the lit suite mpitracer::${suite}"
      ${SUITE_PATH}
      ARGS -v -j 1
      PARAMS mpitracer_site_config=${CMAKE_CURRENT_BINARY_DIR}/lit.site.cfg
      DEPENDS ${MPITRACER_TEST_DEPENDS}
    )
  endforeach()
endfunction()

set(MPITRACER_TEST_DEPENDS
  mpitracer::mpitracer
)

set(MPITRACER_SUITES
  all
)

mpitracer_add_lit_target(SUITES ${MPITRACER_SUITES})

add_test(
  NAME mpitracer-lit-suite
  COMMAND
    ${MPITRACER_LIT_EXEC} -j 1 --param
    mpitracer_site_config=${CMAKE_CURRENT_BINARY_DIR}/lit.site.cfg
    ${CMAKE_CURRENT_SOURCE_DIR}
)

mpitracer_target_format(
  format-mpitracer-tests "Formats project test files"
  TARGETS *.c *.cpp *.h *.hpp
)

if(MPITRACER_TEST_CONFIGURE_IDE)
  function(add_test_target_ide target header sources compile_std linker_language)
    if(NOT sources)
      return()
    endif()

    add_executable(${target} EXCLUDE_FROM_ALL ${header} ${sources})

    target_include_directories(
      ${target} PRIVATE ${PROJECT_SOURCE_DIR}/lib/pass
                        ${PROJECT_SOURCE_DIR}/lib
                        ${PROJECT_SOURCE_DIR}
    )
    target_compile_features(${target} PUBLIC ${compile_std})
    set_target_properties(${target} PROPERTIES LINKER_LANGUAGE ${linker_language})
  endfunction()

  file(GLOB_RECURSE MPITRACER_CXX_TESTS CONFIGURE_DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/*.cpp)
  file(GLOB_RECURSE MPITRACER_CC_TESTS CONFIGURE_DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/*.c)
  file(GLOB_RECURSE MPITRACER_HEADER_TESTS CONFIGURE_DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/*.h)

  add_test_target_ide(mpitracer_cxx_test_objects
    "${MPITRACER_HEADER_TESTS}" "${MPITRACER_CXX_TESTS}"
    cxx_std_17 CXX
  )
  add_test_target_ide(mpitracer_cc_test_objects
    "${MPITRACER_HEADER_TESTS}" "${MPITRACER_CC_TESTS}"
    c_std_11 C
  )
endif()
